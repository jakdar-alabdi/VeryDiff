using VeryDiff
using LinearAlgebra
using JuMP, Gurobi

VeryDiff.NEW_HEURISTIC = false

ϵ = 1.0e-5
num_layer = rand(10:42)
input_dim, output_dim = (2, 2)
layers1 = Layer[]
layers2 = Layer[]

# for l in 1:num_layer
#     # new_input_dim = rand(10:42)
#     W1 = randn(Float64, (2, 2))
#     c1 = randn(Float64, 2)
#     push!(layers1, Dense(W1, c1))
#     push!(layers1, ReLU())

#     W2 = W1 + ϵ * Matrix(1.0I, (2, 2))
#     c2 = c1 + ϵ * ones(Float64, 2)
#     push!(layers2, Dense(W2, c2))
#     push!(layers2, ReLU())
# end

# input_range = max(4.0, 10.0 * rand())

layers1 = [
    Dense([1.3792230734446627 0.18072496804155294; 1.2711459272478396 -0.6222869538436543], [-1.0976112930782012, 1.7509179468964144]),
    ReLU(),
    Dense([-1.617300012546349 -1.1457290973915149; 0.8869264713687858 0.26338624534644156], [3.1238017337202777, -0.0651814615821752]),
    ReLU(),
    Dense([0.6087438875268779 -0.15964247287171593; 1.0892442909356017 -1.8124186045606616], [0.5507334460752988, 1.7067684158911918]),
    ReLU(),
    Dense([-0.07159820079572422 1.8109528957682102; -0.6289415160409288 -0.3802607305461082], [-0.6410759032773328, -0.5459767405446848]),
    ReLU(),
    Dense([-1.746541323008347 -0.09206482764416486; 0.563705220995798 -1.1018553258597146], [0.5561029944953708, 0.6423718603469796]),
    ReLU(),
    Dense([1.8010473076368232 -0.8010201372837944; -1.652665285574487 0.8761220913205824], [-1.3949822486249586, -1.1796542212478704]),
    ReLU(),
    Dense([-0.8862250765901228 1.0513551108548176; 0.7030582743411415 1.3013841267574129], [-0.6638393010122516, -0.12061446128791475]),
    ReLU(),
    Dense([-0.7161468412749878 0.3631185986299728; -1.666710938588277 -0.7074113018810734], [1.2461832048996488, -0.6538184999308579]),
    ReLU(),
    Dense([-0.2230159105206092 -1.7688547897926998; 0.024303975223247204 -0.911824650860103], [1.0630476651777196, 0.979901909751408]),
    ReLU(),
    Dense([-0.20662421462375777 -0.16403175244082258; 1.1604420058622025 -0.8576548998009965], [-0.2647328335485605, 0.09609833395877819]),
    ReLU(),
    Dense([1.363713570827604 -0.5901385259520291; -0.45163614205405145 2.0196202360501996], [1.741774203807737, 0.9455121550593799]),
    ReLU(),
    Dense([0.42578183036800515 -1.849435552006813; -1.4846629867166352 -0.9519431418730938], [0.9954545239557848, -0.9468166606766768]),
    ReLU(),
    Dense([-0.45800479173791253 -0.469613756388144; -0.1086673460001287 -0.5950783226339761], [0.23962229884080774, 0.4418375843512645]),
    ReLU(),
    Dense([0.160587337887127 -0.6593946414693055; 0.39011612148738656 -1.12062905344251], [-1.49908005887843, 0.015767229189535784]),
    ReLU(),
    Dense([-0.10757316094134729 2.202456653327997; 0.46703077437235857 -0.60171666794126], [-0.041800781999059365, 0.7536148586996111]),
    ReLU(),
    Dense([1.3350552173940715 -2.2839380306565005; -0.6368741955811404 0.2703534213793312], [-0.9480347480643606, 0.5159257749653468]),
    ReLU(),
    Dense([-0.14953311780472778 0.2676708558842546; 1.6548701429608208 0.4634442239575621], [-0.8506145495907595, -0.4934342797804856]),
    ReLU(),
    Dense([-0.4525234812204171 -0.47567675313579405; -0.044259565966585306 0.8758454366459557], [-0.18242024403106213, 0.24048149074819522]),
    ReLU(),
    Dense([0.9559851699356834 -0.8588726238645568; -0.8016641950158518 -1.3119316409170558], [0.1814201592494204, -0.48757363789728697]),
    ReLU(),
    Dense([-0.0305695355361467 -1.0503015636894895; 1.1975417728298652 1.4760931313661707], [0.09196702062339994, 0.13049892278150757]),
    ReLU(),
    Dense([0.3052569616076217 -1.3026154592755737; 1.0008866619568695 1.611829296613601], [-0.14113713838787775, -0.8170177519948233]),
    ReLU(),
    Dense([1.1657546955513112 -0.6266951548226481; 0.5808882218161988 -0.019692739907082688], [0.38753818153745334, 0.20673298399139436]),
    ReLU(),
    Dense([0.6060535520179534 -0.7575089415424734; -0.16848494988797633 -0.4167545291132801], [-0.05307353160464454, -1.0101905114580658]),
    ReLU(),
    Dense([-1.5909447792228462 0.032143293470698525; -0.056127612077389734 0.7836649320741601], [-0.6475986402128797, 0.010394954187355898]),
    ReLU(),
    Dense([0.18698430928522128 1.4207235299275678; -0.3107316065800691 -0.08215176366473187], [-0.7918522287455747, 0.4827686196675138]),
    ReLU()
]

layers2 = [
    Dense([1.3792330734446627 0.18072496804155294; 1.2711459272478396 -0.6222769538436543], [-1.097601293078201, 1.7509279468964145]),
    ReLU(),
    Dense([-1.617290012546349 -1.1457290973915149; 0.8869264713687858 0.26339624534644157], [3.1238117337202778, -0.06517146158217521]),
    ReLU(),
    Dense([0.6087538875268779 -0.15964247287171593; 1.0892442909356017 -1.8124086045606616], [0.5507434460752988, 1.7067784158911918]),
    ReLU(),
    Dense([-0.07158820079572423 1.8109528957682102; -0.6289415160409288 -0.3802507305461082], [-0.6410659032773328, -0.5459667405446849]),
    ReLU(),
    Dense([-1.746531323008347 -0.09206482764416486; 0.563705220995798 -1.1018453258597145], [0.5561129944953708, 0.6423818603469795]),
    ReLU(),
    Dense([1.8010573076368233 -0.8010201372837944; -1.652665285574487 0.8761320913205823], [-1.3949722486249585, -1.1796442212478704]),
    ReLU(),
    Dense([-0.8862150765901229 1.0513551108548176; 0.7030582743411415 1.301394126757413], [-0.6638293010122517, -0.12060446128791476]),
    ReLU(),
    Dense([-0.7161368412749879 0.3631185986299728; -1.666710938588277 -0.7074013018810734], [1.246193204899649, -0.653808499930858]),
    ReLU(),
    Dense([-0.2230059105206092 -1.7688547897926998; 0.024303975223247204 -0.911814650860103], [1.0630576651777197, 0.979911909751408]),
    ReLU(),
    Dense([-0.20661421462375776 -0.16403175244082258; 1.1604420058622025 -0.8576448998009966], [-0.26472283354856047, 0.09610833395877819]),
    ReLU(),
    Dense([1.363723570827604 -0.5901385259520291; -0.45163614205405145 2.0196302360501996], [1.7417842038077371, 0.9455221550593799]),
    ReLU(),
    Dense([0.42579183036800516 -1.849435552006813; -1.4846629867166352 -0.9519331418730939], [0.9954645239557848, -0.9468066606766768]),
    ReLU(),
    Dense([-0.4579947917379125 -0.469613756388144; -0.1086673460001287 -0.5950683226339761], [0.23963229884080775, 0.44184758435126453]),
    ReLU(),
    Dense([0.16059733788712702 -0.6593946414693055; 0.39011612148738656 -1.12061905344251], [-1.49907005887843, 0.015777229189535783]),
    ReLU(),
    Dense([-0.1075631609413473 2.202456653327997; 0.46703077437235857 -0.60170666794126], [-0.04179078199905936, 0.753624858699611]),
    ReLU(),
    Dense([1.3350652173940716 -2.2839380306565005; -0.6368741955811404 0.2703634213793312], [-0.9480247480643607, 0.5159357749653467]),
    ReLU(),
    Dense([-0.14952311780472777 0.2676708558842546; 1.6548701429608208 0.4634542239575621], [-0.8506045495907596, -0.4934242797804856]),
    ReLU(),
    Dense([-0.45251348122041707 -0.47567675313579405; -0.044259565966585306 0.8758554366459557], [-0.18241024403106212, 0.24049149074819523]),
    ReLU(),
    Dense([0.9559951699356833 -0.8588726238645568; -0.8016641950158518 -1.3119216409170558], [0.1814301592494204, -0.48756363789728696]),
    ReLU(),
    Dense([-0.0305595355361467 -1.0503015636894895; 1.1975417728298652 1.4761031313661708], [0.09197702062339994, 0.13050892278150758]),
    ReLU(),
    Dense([0.30526696160762173 -1.3026154592755737; 1.0008866619568695 1.611839296613601], [-0.14112713838787774, -0.8170077519948233]),
    ReLU(),
    Dense([1.1657646955513112 -0.6266951548226481; 0.5808882218161988 -0.019682739907082688], [0.38754818153745335, 0.20674298399139437]),
    ReLU(),
    Dense([0.6060635520179534 -0.7575089415424734; -0.16848494988797633 -0.4167445291132801], [-0.05306353160464454, -1.0101805114580658]),
    ReLU(),
    Dense([-1.590934779222846 0.032143293470698525; -0.056127612077389734 0.7836749320741601], [-0.6475886402128798, 0.010404954187355897]),
    ReLU(),
    Dense([0.1869943092852213 1.4207235299275678; -0.3107316065800691 -0.08214176366473187], [-0.7918422287455747, 0.4827786196675138]),
    ReLU()
]
input_range = 4.0

Z = Zonotope(Matrix(input_range * I, input_dim, input_dim), rand(input_dim), nothing)
N₁ = Network(layers1)
N₂ = Network(layers2)

property_check = get_epsilon_property(ϵ)


verify_network(N₁, N₂, zono_bounds(Z), property_check, epsilon_split_heuristic)

println("\n#########################################\n")

deepsplit_lp_search_epsilon(ϵ)(N₁, N₂, Z)
